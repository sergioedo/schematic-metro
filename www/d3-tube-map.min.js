// http://www.pubmap.co.uk/ Version 0.0.7. Copyright 2017 John Walley.
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("d3")):"function"==typeof define&&define.amd?define(["exports","d3"],n):n(t.tubeMap=t.tubeMap||{},t.d3)}(this,function(t,n){"use strict";function e(){function t(t){t.each(function(t){t=o(t),p=t;var r,a,s=n.min(t.raw,function(t){return n.min(t.nodes,function(t){return t.coords[0]})}),l=n.max(t.raw,function(t){return n.max(t.nodes,function(t){return t.coords[0]})}),c=n.min(t.raw,function(t){return n.min(t.nodes,function(t){return t.coords[1]})}),b=n.max(t.raw,function(t){return n.max(t.nodes,function(t){return t.coords[1]})}),S=(l-s)/(b-c),O=(v-y.left-y.right)/(k-y.top-y.bottom),L=O/S;S>O?(r=v-y.left-y.right,a=(k-y.top-y.bottom)*L):(r=(v-y.left-y.right)/L,a=k-y.top-y.bottom),w.domain([s,l]).range([0,r]),A.domain([c,b]).range([a,0]),x.domain([n.min(t.stations.toArray(),function(t){if(void 0!==t.position)return t.position.lon}),n.max(t.stations.toArray(),function(t){if(void 0!==t.position)return t.position.lon})]).range([0,r]),C.domain([n.min(t.stations.toArray(),function(t){if(void 0!==t.position)return t.position.lat}),n.max(t.stations.toArray(),function(t){if(void 0!==t.position)return t.position.lat})]).range([a,0]),f=P*(w(1)-w(0)),h=n.select(this).selectAll("svg").data([t]);var E=h.enter().append("svg").append("g");E.append("rect").attr("width","100%").attr("height","100%").attr("fill","white");var X=function(){m.attr("transform",n.event.transform.toString())};g=n.zoom().scaleExtent([.5,6]).on("zoom",X),m=E.call(g).append("g");var Y=m.append("g").attr("class","river").selectAll("path").data(function(t){return[t.river]}),q=m.append("g").attr("class","lines").selectAll("path").data(function(t){return t.lines.lines}),N=m.append("g").attr("class","interchanges").selectAll("path").data(function(t){return t.stations.interchanges()}),R=m.append("g").attr("class","stations").selectAll("path").data(function(t){return t.stations.normalStations()}),j=m.append("g").attr("class","labels").selectAll("text").data(function(t){return t.stations.toArray()}),z=m.append("g").attr("class","geoStations").style("display","none").selectAll("path").data(function(t){return t.stations.toArray()}),F=m.append("g").attr("class","discrepencies").style("display","none").selectAll("path").data(function(t){return t.stations.toArray()});h.attr("width","100%").attr("height","100%"),Y.enter().append("path").attr("d",i).attr("stroke","#C4E8F8").attr("fill","none").attr("stroke-width",1.8*f),q.enter().append("path").attr("d",i).attr("id",function(t){return t.name}).attr("stroke",function(t){return t.color}).attr("fill","none").attr("stroke-width",function(t){return t.highlighted?1.3*f:f}).classed("line",!0);var Q=n.arc().innerRadius(0).outerRadius(f).startAngle(0).endAngle(2*Math.PI);N.enter().append("g").attr("id",function(t){return t.name}).on("click",function(){var t=n.select(this),r=t.attr("id");e(r),M.call("click",this,r)}).append("path").attr("d",Q).attr("transform",function(t){return"translate("+w(t.x+t.marker[0].shiftX*P)+","+A(t.y+t.marker[0].shiftY*P)+")"}).attr("stroke-width",f/2).attr("fill",function(t){return t.visited?"#000000":"#ffffff"}).attr("stroke",function(t){return t.visited?"#ffffff":"#000000"}).classed("interchange",!0).style("cursor","pointer");var I=n.line().x(function(t){return w(t[0])}).y(function(t){return A(t[1])});R.enter().append("g").attr("id",function(t){return t.name}).on("click",function(){var t=n.select(this),r=t.attr("id");e(r),M.call("click",this,r)}).append("path").attr("d",function(t){var n,e=Math.sqrt(2);switch(t.labelPos.toLowerCase()){case"n":n=[0,1];break;case"ne":n=[1/e,1/e];break;case"e":n=[1,0];break;case"se":n=[1/e,-1/e];break;case"s":n=[0,-1];break;case"sw":n=[-1/e,-1/e];break;case"w":n=[-1,0];break;case"nw":n=[-1/e,1/e]}return I([[t.x+t.shiftX*P+P/2.05*n[0],t.y+t.shiftY*P+P/2.05*n[1]],[t.x+t.shiftX*P+P*n[0],t.y+t.shiftY*P+P*n[1]]])}).attr("stroke",function(t){return t.color}).attr("stroke-width",f/2).attr("fill","none").attr("class",function(t){return t.line}).attr("id",function(t){return t.name}).classed("station",!0),j.enter().append("g").attr("id",function(t){return t.name}).classed("label",!0).on("click",function(){var t=n.select(this),r=t.attr("id");e(r),M.call("click",this,r)}).append("text").text(function(t){return t.label}).attr("dy",.1).attr("x",function(t){return w(t.x+t.labelShiftX)+d(t).pos[0]}).attr("y",function(t){return A(t.y+t.labelShiftY)-d(t).pos[1]}).attr("text-anchor",function(t){return d(t).textAnchor}).style("display",function(t){return!0!==t.hide?"block":"none"}).style("font-size",1.2*f/P+"px").style("-webkit-user-select","none").attr("class",function(t){return t.marker.map(function(t){return t.line}).join(" ")}).classed("highlighted",function(t){return t.visited}).call(u);var _=n.arc().innerRadius(0).outerRadius(f/4).startAngle(0).endAngle(2*Math.PI);z.enter().append("path").attr("d",_).attr("transform",function(t){return"translate("+x(void 0!==t.position?t.position.lon:NaN)+","+C(void 0!==t.position?t.position.lat:NaN)+")"}).attr("id",function(t){return t.name}).attr("fill","#888888"),F.enter().append("path").attr("d",function(t){return n.line()([[w(t.x),A(t.y)],[x(t.position.lon),C(t.position.lat)]])}).attr("id",function(t){return t.name}).attr("stroke","#AAAAAA").attr("stroke-width",f/4).style("stroke-dasharray","3, 3")})}function e(t){n.select(".labels").selectAll(".label").classed("selected",!1),n.select(".labels").select("#"+t).classed("selected",!0)}function s(t,e){n.select(".labels").select("#"+t).select("text").classed("highlighted",e)}function i(t){for(var n,e,r,a,s,i="",o=t.nodes,l=w(1)-w(0),c=[t.shiftCoords[0]*f/l,t.shiftCoords[1]*f/l],d="diagonal",u=0;u<o.length;u++)if(u>0){n=o[u],e=o[u-1];r=Math.round(e.coords[0]-n.coords[0]),a=Math.round(e.coords[1]-n.coords[1]);var h=[0,0];if(u===o.length-1)if(0==r||0==a)r>0&&(h=[-f/(4*l),0]),r<0&&(h=[f/(4*l),0]),a>0&&(h=[0,-f/(4*l)]),a<0&&(h=[0,f/(4*l)]);else{var p=Math.sqrt(2);r>0&&a>0&&(h=[-f/(4*l*p),-f/(4*l*p)]),r>0&&a<0&&(h=[-f/(4*l*p),f/(4*l*p)]),r<0&&a>0&&(h=[f/(4*l*p),-f/(4*l*p)]),r<0&&a<0&&(h=[f/(4*l*p),f/(4*l*p)])}if(s=[[w(e.coords[0]+c[0]),A(e.coords[1]+c[1])],[w(n.coords[0]+c[0]+h[0]),A(n.coords[1]+c[1]+h[1])]],0==r||0==a)d="udlr",i+="L"+s[1][0]+","+s[1][1];else if(Math.abs(r)==Math.abs(a)&&Math.abs(r)>1)d="diagonal",i+="L"+s[1][0]+","+s[1][1];else if(1==Math.abs(r)&&1==Math.abs(a))switch(n.dir.toLowerCase()){case"e":i+="Q"+s[1][0]+","+s[0][1]+","+s[1][0]+","+s[1][1];break;case"s":case"n":i+="Q"+s[0][0]+","+s[1][1]+","+s[1][0]+","+s[1][1];break;case"w":i+="Q"+s[1][0]+","+s[0][1]+","+s[1][0]+","+s[1][1]}else if(1==Math.abs(r)&&2==Math.abs(a)||2==Math.abs(r)&&1==Math.abs(a)){var m;1==r?"udlr"==d?m=[s[0][0],s[0][1]+(s[1][1]-s[0][1])/2]:"diagonal"==d&&(m=[s[1][0],s[0][1]+(s[1][1]-s[0][1])/2]):-1==r?"udlr"==d?m=[s[0][0],s[0][1]+(s[1][1]-s[0][1])/2]:"diagonal"==d&&(m=[s[1][0],s[0][1]+(s[1][1]-s[0][1])/2]):-2==r?"udlr"==d?m=[s[0][0]+(s[1][0]-s[0][0])/2,s[0][1]]:"diagonal"==d&&(m=[s[0][0]+(s[1][0]-s[0][0])/2,s[1][1]]):2==r&&("udlr"==d?m=[s[0][0]+(s[1][0]-s[0][0])/2,s[0][1]]:"diagonal"==d&&(m=[s[0][0]+(s[1][0]-s[0][0])/2,s[1][1]])),i+="C"+m[0]+","+m[1]+","+m[0]+","+m[1]+","+s[1][0]+","+s[1][1]}}else{n=o[u+1],e=o[u],r=Math.round(e.coords[0]-n.coords[0]),a=Math.round(e.coords[1]-n.coords[1]);var g=[0,0];if(0==r||0==a)r>0&&(g=[f/(4*l),0]),r<0&&(g=[-f/(4*l),0]),a>0&&(g=[0,f/(4*l)]),a<0&&(g=[0,-f/(4*l)]);else{var p=Math.sqrt(2);r>0&&a>0&&(g=[f/(4*l*p),f/(4*l*p)]),r>0&&a<0&&(g=[f/(4*l*p),-f/(4*l*p)]),r<0&&a>0&&(g=[-f/(4*l*p),f/(4*l*p)]),r<0&&a<0&&(g=[-f/(4*l*p),-f/(4*l*p)])}s=[w(e.coords[0]+c[0]+g[0]),A(e.coords[1]+c[1]+g[1])],i+="M"+s[0]+","+s[1]}return i}function o(t){var n={};return n.raw=t.lines,n.river=t.river,n.stations=l(t),n.lines=c(t.lines),n}function l(t){return t.lines.forEach(function(n){for(var e=0;e<n.nodes.length;e++){var r=n.nodes[e];if(r.hasOwnProperty("name")){if(!t.stations.hasOwnProperty(r.name))throw new Error("Cannot find station with key: "+r.name);var a=t.stations[r.name];a.x=r.coords[0],a.y=r.coords[1],void 0===a.labelPos&&(a.labelPos=r.labelPos,a.labelShiftX=r.hasOwnProperty("shiftCoords")?r.shiftCoords[0]:n.shiftCoords[0],a.labelShiftY=r.hasOwnProperty("shiftCoords")?r.shiftCoords[1]:n.shiftCoords[1]),r.hasOwnProperty("canonical")&&(a.labelShiftX=r.hasOwnProperty("shiftCoords")?r.shiftCoords[0]:n.shiftCoords[0],a.labelShiftY=r.hasOwnProperty("shiftCoords")?r.shiftCoords[1]:n.shiftCoords[1],a.labelPos=r.labelPos),a.label=t.stations[r.name].title,a.position=t.stations[r.name].position,a.visited=!1,r.hide||(a.marker=a.marker||[],a.marker.push({line:n.name,color:n.color,labelPos:r.labelPos,marker:r.hasOwnProperty("marker")?r.marker:"station",shiftX:r.hasOwnProperty("shiftCoords")?r.shiftCoords[0]:n.shiftCoords[0],shiftY:r.hasOwnProperty("shiftCoords")?r.shiftCoords[1]:n.shiftCoords[1]}))}}}),new r(t.stations)}function c(t){var n=[];return t.forEach(function(t){var e={name:t.name,title:t.label,stations:[],color:t.color,shiftCoords:t.shiftCoords,nodes:t.nodes,highlighted:!1};n.push(e);for(var r=0;r<t.nodes.length;r++){var a=t.nodes[r];a.hasOwnProperty("name")&&e.stations.push(a.name)}}),new a(n)}function d(t){var n,e,r=1.8*f,a=t.label.split(/\n/).length,s=Math.sqrt(2);switch(t.labelPos.toLowerCase()){case"n":n=[0,f*(a-1)+r],e="middle";break;case"ne":n=[r/s,(f*(a-1)+r)/s],e="start";break;case"e":n=[r,0],e="start";break;case"se":n=[r/s,-r/s],e="start";break;case"s":n=[0,-P*r],e="middle";break;case"sw":n=[-r/s,-1.4*r/s],e="end";break;case"w":n=[-r,0],e="end";break;case"nw":n=[-(f*(a-1)+r)/s,(f*(a-1)+r)/s],e="end"}return{pos:n,textAnchor:e}}function u(t){t.each(function(){for(var t=n.select(this),e=t.text().split(/\n/),r=t.attr("y"),a=t.attr("x"),s=parseFloat(t.attr("dy")),i=(t.text(null).append("tspan").attr("x",a).attr("y",r).attr("dy",s+"em").text(e[0]),1);i<e.length;i++)t.append("tspan").attr("x",a).attr("y",r).attr("dy",1.1*i+s+"em").text(e[i])})}var f,h,p,m,g,b,y={top:80,right:80,bottom:20,left:80},v=760,k=640,w=n.scaleLinear(),A=n.scaleLinear(),x=n.scaleLinear(),C=n.scaleLinear(),P=1.2,M=n.dispatch("click");return t.width=function(n){return arguments.length?(v=n,t):v},t.height=function(n){return arguments.length?(k=n,t):k},t.margin=function(n){return arguments.length?(y=n,t):y},t.highlightLine=function(t){var e=n.select("#map").selectAll(".line"),r=n.select("#map").selectAll(".station"),a=n.select("#map").selectAll(".label");e.classed("translucent",!0),r.classed("translucent",!0),a.classed("translucent",!0),r.filter("."+t).classed("translucent",!1),a.filter("."+t).classed("translucent",!1),n.select("#"+t).classed("translucent",!1)},t.unhighlightAll=function(){var t=n.select("#map").selectAll(".line"),e=n.select("#map").selectAll(".station"),r=n.select("#map").selectAll(".label");t.classed("translucent",!1),e.classed("translucent",!1),r.classed("translucent",!1)},t.unhighlightLine=function(){this.unhighlightAll()},t.highlightNearestStation=function(t){p.stations.stations[t]},t.centerOnPub=function(t){if(void 0!==t){var n=p.stations.stations[t],e=window.innerWidth,r=window.innerHeight;b=[-2*w(n.x)+e/2,-2*A(n.y)+r/2],g.translateBy(b).scaleTo(2),m.transition().duration(750).attr("transform","translate("+b[0]+","+b[1]+")scale(2)")}},t.addStation=function(t){s(t,!0)},t.removeStation=function(t){s(t,!1)},t.visitStations=function(t){n.selectAll(".labels").select("text").classed("highlighted",!1),t.map(function(t){s(t,!0)})},t.on=function(t,n){M.on(t,n)},t.selectStation=function(t){e(t)},t}var r=function(t){this.stations=t};r.prototype.toArray=function(){var t=[];for(var n in this.stations)if(this.stations.hasOwnProperty(n)){var e=this.stations[n];e.name=n,t.push(e)}return t},r.prototype.interchanges=function(){return this.toArray().filter(function(t){return"interchange"===t.marker[0].marker})},r.prototype.normalStations=function(){var t=this.toArray(),n=t.filter(function(t){return"interchange"!==t.marker[0].marker}),e=[];return n.forEach(function(t){t.marker.forEach(function(n){e.push({name:t.name,line:n.line,x:t.x,y:t.y,color:n.color,shiftX:n.shiftX,shiftY:n.shiftY,labelPos:t.labelPos})})}),e},r.prototype.visited=function(){return this.toArray().filter(function(t){return t.visited})},r.prototype.visitedFriendly=function(){return this.visited().map(function(t){return t.title})},r.prototype.isVisited=function(t){return this.stations[t].visited};var a=function(t){this.lines=t};a.prototype.highlightLine=function(t){this.lines.forEach(function(n){n.name===t&&(n.highlighted=!0)})},a.prototype.unhighlightLine=function(t){this.lines.forEach(function(n){n.name===t&&(n.highlighted=!1)})},t.tubeMap=e,Object.defineProperty(t,"__esModule",{value:!0})});